{{/*
 * Copyright (C) 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */}}

{{Global "module" ""}}
{{Include "go_common.tmpl"}}
{{Include "go_convert_common.tmpl"}}
{{$ | Macro "state_serialize.go" | NewReflow "\t" | Write "state_serialize.go"}}

{{define "state_serialize.go"}}
  {{Global "Store" (printf "%s_pb" (Global "OutputDir"))}}
  §{{Copyright "generated" "apic"}}§
  package {{Global "OutputDir"}}¶
  ¶
  import (»¶
    "context"¶
    "unsafe"¶
¶
    "github.com/google/gapid/core/data/protoconv"¶
    "github.com/google/gapid/gapis/api/{{Global "OutputDir"}}/{{Global "Store"}}"¶
    "github.com/google/gapid/gapis/memory"¶
    "github.com/google/gapid/gapis/memory/memory_pb"¶
  «)¶
  ¶
  // Just in case it is not used¶
  var _ memory.PoolID¶
  var _ memory_pb.Pointer¶
  var _ unsafe.Pointer ¶
  {{$p := print (Global "Store") ".InitialState"}}
  ¶
  func init() {»¶
    protoconv.Register(¶
      func(ctx context.Context, ref_cb func(interface{}) uint64, in *State) (*{{$p}}, error) { return in.ToProto(ref_cb), nil },¶
      func(ctx context.Context, ref_cb func(uint64, interface{}), in *{{$p}}) (*State, error) { v := StateFrom(in, ref_cb); return &v, nil },¶
    «)¶
  «}¶
  ¶

  // ToProto returns the storage form of the State.¶
  func (ϟa *State) ToProto(ref_cb func(interface{}) uint64) *{{$p}} {»¶
    to := &{{$p}}{}¶
    {{range $g := $.Globals}}
      {{if (GetAnnotation $g "serialize")}}
        {{Template "Convert.To" "Field" $g "Outer" "InitialState"}}
      {{end}}
    {{end}}
    return to¶
  «}¶
  ¶
  // StateFrom builds a State from the storage form.¶
  func StateFrom(from *{{$p}},
                      ref_cb func(uint64, interface{})) State {»¶
    ϟa := State{}¶
    {{range $g := $.Globals}}
      {{if (GetAnnotation $g "serialize")}}
        {{Template "Convert.From" "Field" $g "Outer" "InitialState"}}
      {{end}}
    {{end}}
    return ϟa¶
  «}¶

{{end}}
